# SQL

<body id="start">
<div class="topnav">
  <a href='index.html#frontpage'>Front page</a>
  <a href='data-visualisation.html#data-visualisation'>Data visualisation</a>
  <a href='reproductibility.html#Reproductibility'>Reproductibility</a>
  <a href='sorting-directories.html#sorting-directories'>Directory structure</a>
  <a href='cv.html#cv'>CV</a>
  <a href='plan-for-future.html#plan-for-future'>The future</a>
  <a href='sql.html#SQL'>SQL</a>
</div>

In order to prove my skills in the field of data handling and SQL, this page will show me work with flu data, dengue data and the gapminder data from the {dslabs} package. The flu data and dengue data are both supplied by google, "www.google.org/flutrends AND www.google.org/denguetrends"

First of all, all datasets will be read and inspected in R

```{r dependencies_008, include=FALSE}
library(dslabs)
library(tidyverse)
library(RPostgreSQL)
library(RPostgres)
library(DBI)
library(here)
```


```{r inspectingData}
#The gapminder dataset
gapminder %>% head()

dengue<-read.csv("./data.raw/dengue_data.csv", skip = 10)
#The dengue dataset
dengue %>% head()

flu<-read.csv("./data.raw/flu_data.csv", skip = 10)
#The flu dataset
flu %>% dplyr::select(Date:Japan) %>% head() #Selected till Japan for a cleaner table
```

Both the flu and the dengue datasets are not tidy: Each row contains the incidence rate (observation) of dengue/flu of multiple countries, while each row is only supposed to have 1 observation. The datasets will be wrangled to be tidy

```{r wranglingDataSets}
dengue_tidy<-dengue %>% pivot_longer(cols = Argentina:Venezuela,
                        names_to = "country",
                        values_to = "dengue_incidence")
dengue_tidy %>% head()

flu_tidy<-flu %>% pivot_longer(cols = Argentina:Uruguay,
                     names_to = "country",
                     values_to = "flu_incidence")
flu_tidy %>% head()



```

Now the data is tidy, however, to make the dengue/flu data relational, the "date" data needs to be properly synchronized. To do this, the "date" will be split into "year", "month" and "day". These will be changed from character vectors to integers

```{r}
flu_separate<-flu_tidy %>% separate(col = Date, into = c("year", "month", "day"))
flu_separate$year<-flu_separate$year %>% as.integer()
flu_separate$month<-flu_separate$month %>% as.integer()
flu_separate$day<-flu_separate$day %>% as.integer()

dengue_separate<-dengue_tidy %>% separate(col = Date, into = c("year", "month", "day"))
dengue_separate$year<-dengue_separate$year %>% as.integer()
dengue_separate$month<-dengue_separate$month %>% as.integer()
dengue_separate$day<-dengue_separate$day %>% as.integer()
```

Now, with the data properly relational, it'll be written into .csv's and .rds'

```{r, eval=FALSE}
flu_separate %>% write.csv(file = "./data/flu.csv")
flu_separate %>% write_rds(file = "./data/flu.rds")
dengue_separate %>% write.csv(file = "./data/dengue.csv")
dengue_separate %>% write_rds(file = "./data/dengue.rds")
gapminder %>% write.csv(file = "./data/gapminder.csv")
gapminder %>% write_rds(file = "./data/gapminder.rds")
```


Using the SQL script shown in the screenshot below, a SQL database has been created called "workflowsdb".

<img src="./images/SQL_1.png">

Using RPostgreSQL, the created datasets will be inserted into this database



```{r, eval=FALSE}
source(here("R/login_credentials.R"))
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "workflowsdb",
                 host = "localhost", 
                 port = 5432,
                 user= "postgres",
                 password = rawToChar(pwd))

dbListTables(con)

dbWriteTable(con, "gapminder", gapminder)
dbWriteTable(con, "dengue", dengue_separate)
dbWriteTable(con, "flu", flu_separate)
```

To inspect the database in order to check if all data has been transfered correctly, another SQL script has been used. Once again, screenshots of this script have been added underneath.

<img src="./images/SQL_2.png">

<img src="./images/SQL_3.png">

For further insurance, the data will also be inspected via R
```{r, warning=FALSE}
gapminder<-dbReadTable(con, "gapminder")
gapminderyear_unique<-gapminder$year %>% unique()

dengue<-dbReadTable(con, "dengue")
dengueyear_unique<-dengue$year %>% unique()

flu<-dbReadTable(con, "flu")
fluyear_unique<-flu$year %>% unique

flu_dengue_year<-fluyear_unique == dengueyear_unique
table(flu_dengue_year) # TRUE means that the years between flu and dengue are the same, FALSE means that there's a year that's not the same
gapminder_dengue_year<-gapminderyear_unique == dengueyear_unique
table(gapminder_dengue_year) # TRUE means that the years between flu/dengue and gapminder are the same, FALSE means that there's a year that's not the same

flu_dengue_countries<-flu$country %>% unique() == dengue$country %>% unique()
table(flu_dengue_countries) # TRUE means that the countries between flu and dengue are the same, FALSE means that there's a country in 1 dataset that isn't in the other
flu_dengue_gapminder_countries<-dengue$country %>% unique() == gapminder$country %>% unique()
table(flu_dengue_gapminder_countries) # TRUE means that the countries between flu/dengue and gapminder are the same, FALSE means that there's a country in 1 dataset that isn't in the other
```

Based on these inspections, we have seen that:

- Gapminder contains a bigger range of years than flu/dengue

- Gapminder contains a bigger range of countries than flu/dengue

- Flu/dengue both contain the exact same countries and years

Since the year/country columns are (partly) the same between gapminder and dengue/flu, we can join these datasets.

```{r}
data_full<-left_join(gapminder, dengue, by = c("country", "year")) %>% left_join(flu, by = c("country", "year", "month", "day"))

data_full %>% head()


```


```{r, eval=FALSE}
#So, we have our datasets: flu_tidy and dengue_tidy. We want to join them with gapminder by country AND year
#Problem: Year here is given as a exact date, not a year.
#Solution: Transform the date into a year
date_flu<-sub("-.*","",flu_tidy$Date)
flu_tidy$year<-date_flu
flu_tidy$year<-flu_tidy$year %>% as.integer()
flu_tidy

date_dengue<-sub("-.*", "", dengue_tidy$Date)
dengue_tidy$year<-date_dengue
dengue_tidy$year<-dengue_tidy$year %>% as.integer()
dengue_tidy

#Now, the question: we have multiple instances of the year per country in each file. I want to calculate the mean incidence per year per country. How?
#Solution: Just dont! Make a new file for year and just left join based on that!


```





```{r, eval=FALSE}
rowMeans(flu)

flu_tidy %>% group_by(country) %>% mean()

flu_tidy %>% group_by(country) %>% summarise(
  mean=mean(flu_incidence[flu_tidy$date2=='2002'], na.rm=TRUE)
)

flu_tidy %>% group_by(country) %>% rowMeans(flu_tidy$flu_incidence, na.rm=TRUE)

rowMeans(flu_tidy$flu_incidence)


mean(flu_tidy[flu_tidy$date2=='2003', 'flu_incidence'])

date<-sub("-.*","",flu_tidy$Date)
flu_tidy$date2<-date

flu_tidy$date2 %>% unique()

flu_tidy

flu_tidy %>% group_by(country) %>% summarise(
  year=unique(date2),
  incidence=mean(flu_incidence, na.rm=TRUE)
)

flu_tidy

mean(flu_tidy$flu_incidence, na.)
```


